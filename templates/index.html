<!DOCTYPE html>
<html>
<head>
    <title>Team Task Tracker</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .board-container {
            display: flex;
            gap: 20px;
        }
        .board {
            flex: 1;
            background: #f4f4f4;
            padding: 10px;
            border-radius: 8px;
        }
        .board h2 {
            text-align: center;
        }
        .task-item {
            background: #fff;
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
            box-shadow: 0 1px 2px #ccc;
        }
        .header-bar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            background: #007bff;
            color: white;
            padding: 10px;
            border-radius: 8px 8px 0 0;
        }
        .flash-message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .flash-message .error {
            color: red;
        }
        .flash-message .success {
            color: green;
        }
    </style>
</head>
<body>
    <div class="header-bar">
        {% if session.username %}
            <span>Welcome, {{ session.username }}!</span>
            <form action="{{ url_for('logout') }}" method="get" style="display:inline;">
                <button type="submit">Logout</button>
            </form>
        {% endif %}
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="flash-message">
        {% for category, message in messages %}
            <div class="{{ category }}">{{ message }}</div>
        {% endfor %}
        </div>
    {% endif %}
    {% endwith %}

    <h1>Task Dashboard</h1>
    {% if session.username %}
    <form action="/add" method="post">
        <input type="text" name="title" placeholder="Task Title" required>
        <select name="assigned_to" required>
            {% for user in users %}
                <option value="{{ user['username'] }}" {% if task and task.assigned_to == user['username'] %}selected{% endif %}>{{ user['username'] }}</option>
            {% endfor %}
        </select>
        <input type="date" name="due_date" data-warning-id="due-warning-new">
        <span id="due-warning-new" style="color:red"></span>
        <select name="status">
            <option value="To Do">To Do</option>
            <option value="In Progress">In Progress</option>
            <option value="Done">Done</option>
        </select>
        <button type="submit">Add Task</button>
    </form>
    {% endif %}

    <div class="board-container">
        <div class="board">
            <h2>To Do</h2>
            {% set found = false %}
            {% for task in tasks if task.status == 'To Do' %}
              {% set found = true %}
                <div class="task-item">
                    <strong>{{ task.title }}</strong><br>
                    {{ task.assigned_to }}<br>
                    Due: {{ task.due_date }}<br>
                    <form action="{{ url_for('update_status', task_id=task.id) }}" method="post" style="display:inline;">
                        <select name="status">
                            <option value="To Do" {% if task.status == 'To Do' %}selected{% endif %}>To Do</option>
                            <option value="In Progress" {% if task.status == 'In Progress' %}selected{% endif %}>In Progress</option>
                            <option value="Done" {% if task.status == 'Done' %}selected{% endif %}>Done</option>
                        </select>
                        <button type="submit">Change</button>
                    </form>
                    {% if session.role == 'admin' %}
                        <a href="{{ url_for('edit_task', task_id=task.id) }}">Edit</a>
                        <form action="{{ url_for('delete_task', task_id=task.id) }}" method="post" style="display:inline;">
                            <button type="submit" onclick="return confirm('Are you sure you want to delete this task?');">Delete</button>
                        </form>
                    {% endif %}
                </div>
            {% endfor %}
            {% if not found %}
              <div>No tasks</div>
            {% endif %}
        </div>
        <div class="board">
            <h2>In Progress</h2>
            {% for task in tasks if task.status == 'In Progress' %}
                <div class="task-item">
                    <strong>{{ task.title }}</strong><br>
                    {{ task.assigned_to }}<br>
                    Due: {{ task.due_date }}<br>
                    <form action="{{ url_for('update_status', task_id=task.id) }}" method="post" style="display:inline;">
                        <select name="status">
                            <option value="To Do" {% if task.status == 'To Do' %}selected{% endif %}>To Do</option>
                            <option value="In Progress" {% if task.status == 'In Progress' %}selected{% endif %}>In Progress</option>
                            <option value="Done" {% if task.status == 'Done' %}selected{% endif %}>Done</option>
                        </select>
                        <button type="submit">Change</button>
                    </form>
                    {% if session.role == 'admin' %}
                        <a href="{{ url_for('edit_task', task_id=task.id) }}">Edit</a>
                        <form action="{{ url_for('delete_task', task_id=task.id) }}" method="post" style="display:inline;">
                            <button type="submit" onclick="return confirm('Are you sure you want to delete this task?');">Delete</button>
                        </form>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
        <div class="board">
            <h2>Done</h2>
            {% for task in tasks if task.status == 'Done' %}
                <div class="task-item">
                    <strong>{{ task.title }}</strong><br>
                    {{ task.assigned_to }}<br>
                    Due: {{ task.due_date }}<br>
                    <form action="{{ url_for('update_status', task_id=task.id) }}" method="post" style="display:inline;">
                        <select name="status">
                            <option value="To Do" {% if task.status == 'To Do' %}selected{% endif %}>To Do</option>
                            <option value="In Progress" {% if task.status == 'In Progress' %}selected{% endif %}>In Progress</option>
                            <option value="Done" {% if task.status == 'Done' %}selected{% endif %}>Done</option>
                        </select>
                        <button type="submit">Change</button>
                    </form>
                    {% if session.role == 'admin' %}
                        <a href="{{ url_for('edit_task', task_id=task.id) }}">Edit</a>
                        <form action="{{ url_for('delete_task', task_id=task.id) }}" method="post" style="display:inline;">
                            <button type="submit" onclick="return confirm('Are you sure you want to delete this task?');">Delete</button>
                        </form>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    </div>

    <script>
function validateDate(input, warningId) {
    const inputDate = new Date(input.value);
    const now = new Date();
    now.setHours(0,0,0,0);
    const maxDate = new Date();
    maxDate.setFullYear(now.getFullYear() + 1);

    let warning = '';
    if (input.value && inputDate < now) {
        warning = 'Due date must be in the future!';
    } else if (input.value && inputDate > maxDate) {
        warning = 'Warning: Due date is more than 12 months ahead!';
    }
    document.getElementById(warningId).textContent = warning;
    return warning === '';
}

document.addEventListener('DOMContentLoaded', function() {
    const dueDateInputs = document.querySelectorAll('input[name="due_date"]');
    dueDateInputs.forEach(function(input) {
        const warningId = input.getAttribute('data-warning-id');
        input.addEventListener('change', function() {
            validateDate(input, warningId);
        });
        input.form && input.form.addEventListener('submit', function(e) {
            if (!validateDate(input, warningId)) {
                e.preventDefault();
            }
        });
    });
});
</script>
</body>
</html>